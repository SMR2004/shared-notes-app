<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ultimate Shared Sticky Notes Wall ‚Äî Optimized (No Shadows)</title>
<style>
/* Performance-optimized CSS: NO SHADOWS, NO BLURS, minimal transitions */
* { box-sizing: border-box; margin: 0; padding: 0; }
body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f0f0; overflow: auto; }
#wall { position: relative; width: 100%; min-height: 100vh; background: #f5f5f5; padding: 20px; transition: background 0.2s linear; background-size: cover; background-position: center; }
#toolbar { position: fixed; top: 20px; left: 20px; display: flex; gap: 10px; z-index: 1000; flex-wrap: wrap; background: rgba(255,255,255,0.98); padding: 10px; border-radius: 10px; border: 1px solid rgba(0,0,0,0.06); }
.tool-btn { padding: 9px 12px; background: white; border: 1px solid rgba(0,0,0,0.06); border-radius: 8px; font-weight: 600; cursor: pointer; transition: transform 0.08s linear; }
.tool-btn:active { transform: scale(0.98); }
.color-palette, .background-picker, .search-picker { display: none; position: absolute; top: 60px; left: 0; background: white; padding: 10px; border-radius: 10px; z-index: 1001; gap: 8px; }
.color-option { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
.color-option.active { border-color: rgba(0,0,0,0.12); transform: scale(1.05); }
.note { position: absolute; min-width: 200px; min-height: 150px; background: #fff176; border-radius: 10px; padding: 12px; cursor: move; overflow: hidden; border: 1px solid rgba(0,0,0,0.06); }
.note:hover { transform: translateY(-2px); }
.note.dragging { transform: rotate(2deg) scale(1.02); z-index: 1002; transition: none !important; }
.note-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid rgba(0,0,0,0.04); }
.note-title { font-weight: 700; font-size: 14px; border: none; background: transparent; outline: none; width: 100%; padding: 4px; border-radius: 6px; font-family: inherit; }
.note-title:focus { background: rgba(255,255,255,0.6); }
.note-controls { display: flex; gap: 6px; }
.note-btn { width: 26px; height: 26px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; background: rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.04); }
.note-content { width: 100%; min-height: 80px; border: none; background: transparent; outline: none; resize: none; font-family: inherit; font-size: 14px; line-height: 1.5; border-radius: 6px; padding: 4px; }
.note-tags { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px; }
.tag { background: rgba(0,0,0,0.04); padding: 2px 6px; border-radius: 10px; font-size: 10px; border: 1px solid rgba(0,0,0,0.03); }
.standalone-image-container { position: absolute; border-radius: 10px; cursor: move; border: 2px solid rgba(255,255,255,0.6); max-width: 400px; max-height: 400px; overflow: hidden; background: #fff; }
.standalone-image { width: 100%; height: 100%; object-fit: contain; border-radius: 8px; }
.note-image { max-width: 100%; max-height: 150px; border-radius: 8px; margin-top: 8px; display: block; cursor: pointer; }
.resize-handle { position: absolute; bottom: 5px; right: 5px; width: 22px; height: 22px; background: rgba(0,0,0,0.06); border-radius: 6px; cursor: nwse-resize; opacity: 0; display: flex; align-items: center; justify-content: center; font-size: 12px; }
.note:hover .resize-handle, .standalone-image-container:hover .resize-handle { opacity: 1; }
.status { position: fixed; top: 20px; right: 20px; background: white; padding: 10px 14px; border-radius: 8px; font-size: 14px; z-index: 1000; border: 1px solid rgba(0,0,0,0.06); }
.image-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
.image-modal img { max-width: 90%; max-height: 90%; border-radius: 12px; }
.close-modal { position: absolute; top: 20px; right: 20px; color: white; font-size: 28px; cursor: pointer; background: rgba(0,0,0,0.5); width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
.sound-toggle { position: fixed; bottom: 20px; left: 20px; background: white; border: none; border-radius: 50%; width: 48px; height: 48px; cursor: pointer; z-index: 1000; font-size: 20px; border: 1px solid rgba(0,0,0,0.06); }
.sound-toggle.muted { opacity: 0.6; transform: scale(0.95); }
@media (max-width: 768px) { #toolbar { flex-direction: column; align-items: flex-start; } .tool-btn { font-size: 12px; padding: 8px 10px; } .note { min-width: 180px; min-height: 120px; } .standalone-image-container { max-width: 300px; max-height: 300px; } }
</style>
</head>
<body>
<div id="toolbar">
  <button id="addBtn" class="tool-btn">+ New Note</button>
  <button id="addImageBtn" class="tool-btn">üì∏ Add Image</button>
  <button id="colorBtn" class="tool-btn">üé® Colors</button>
  <button id="bgBtn" class="tool-btn">üèûÔ∏è Background</button>
  <button id="searchBtn" class="tool-btn">üîç Search</button>
  <button id="exportBtn" class="tool-btn">üì§ Export</button>
  <button id="importBtn" class="tool-btn">üì• Import</button>
  <div id="colorPalette" class="color-palette">
    <div class="color-option active" data-color="#fff176" style="background-color: #fff176;"></div>
    <div class="color-option" data-color="#81d4fa" style="background-color: #81d4fa;"></div>
    <div class="color-option" data-color="#a5d6a7" style="background-color: #a5d6a7;"></div>
    <div class="color-option" data-color="#f48fb1" style="background-color: #f48fb1;"></div>
  </div>
  <div id="backgroundPicker" class="background-picker">
    <div class="bg-option active" data-bg="default">Default</div>
    <div class="bg-option" data-bg="upload">Upload Image</div>
    <div class="bg-option" data-bg="black">Black</div>
    <div class="bg-option" data-bg="white">White</div>
    <div class="bg-option" data-bg="blue">Blue</div>
    <div class="bg-option" data-bg="green">Green</div>
  </div>
  <div id="searchBox" class="search-picker" style="display:none; left:200px;">
    <input type="text" id="searchInput" placeholder="Search notes..." style="width:100%; padding:8px; border:1px solid rgba(0,0,0,0.06); border-radius:6px; margin-bottom:8px;">
    <button id="doSearch" class="tool-btn" style="width:100%;">Search</button>
    <button id="clearSearchBtn" class="tool-btn" style="width:100%; background:#666; color:#fff; margin-top:6px;">Clear</button>
  </div>
</div>

<div id="status" class="status">Ready! Create your first note.</div>
<div id="wall" class="notes-container"></div>

<button id="soundToggle" class="sound-toggle" title="Toggle sounds">üîä</button>

<input type="file" id="imageUpload" accept="image/*" class="hidden">
<input type="file" id="standaloneImageUpload" accept="image/*" class="hidden">
<input type="file" id="bgUpload" accept="image/*" class="hidden">
<input type="file" id="importFile" accept="application/json" class="hidden">

<div id="imageModal" class="image-modal">
  <span class="close-modal">&times;</span>
  <img id="modalImage" src="" alt="Enlarged image">
</div>

<script>
// --- Elements ---
const wall = document.getElementById('wall');
const status = document.getElementById('status');
const imageUpload = document.getElementById('imageUpload');
const standaloneImageUpload = document.getElementById('standaloneImageUpload');
const bgUpload = document.getElementById('bgUpload');
const importFile = document.getElementById('importFile');
const imageModal = document.getElementById('imageModal');
const modalImage = document.getElementById('modalImage');

const addBtn = document.getElementById('addBtn');
const addImageBtn = document.getElementById('addImageBtn');
const colorBtn = document.getElementById('colorBtn');
const colorPalette = document.getElementById('colorPalette');
const bgBtn = document.getElementById('bgBtn');
const backgroundPicker = document.getElementById('backgroundPicker');
const searchBtn = document.getElementById('searchBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const searchBox = document.getElementById('searchBox');
const searchInput = document.getElementById('searchInput');
const doSearch = document.getElementById('doSearch');
const clearSearchBtn = document.getElementById('clearSearchBtn');
const closeModal = document.querySelector('.close-modal');
const soundToggle = document.getElementById('soundToggle');

// --- State ---
let notes = [];
let isDragging = false;
let currentElement = null;
let dragOffset = {x:0,y:0};
let isResizing = false;
let selectedColor = '#fff176';
let currentColorNote = null;
let isUserTyping = false;
let resizeStartSize = {width:0,height:0};
let resizeStartPos = {x:0,y:0};
let soundsEnabled = true;
const backgrounds = { default: '#f5f5f5', black: '#000000', white: '#ffffff', blue: '#2196F3', green: '#4CAF50' };

// --- Init ---
async function init() {
  setupEventListeners();
  loadLocalBackground();
  await loadNotes();
  // Reduced refresh frequency to reduce server load and reflow work
  setInterval(smartRefresh, 5000);
  showStatus('Ready! Shared notes wall loaded.');
}

function loadLocalBackground() {
  const saved = localStorage.getItem('wallBackground');
  if (saved) {
    try { const background = JSON.parse(saved); applyBackground(background); return; } catch(e) { /* continue */ }
  }
  applyBackground({type:'color', value:'#f5f5f5'});
}
function applyBackground(background) {
  if (background.type === 'color') { document.getElementById('wall').style.backgroundImage = 'none'; document.getElementById('wall').style.backgroundColor = background.value; }
  else if (background.type === 'image') { document.getElementById('wall').style.backgroundImage = `url(${background.value})`; }
}
function saveLocalBackground(type,value){ localStorage.setItem('wallBackground', JSON.stringify({type,value})); applyBackground({type,value}); showStatus('Background updated!'); }

// --- Data sync ---
async function smartRefresh(){ if (isUserTyping) return; try { const response = await fetch('/api/notes'); if (!response.ok) return; const serverNotes = await response.json(); if (JSON.stringify(notes) !== JSON.stringify(serverNotes) && !isUserTyping) { notes = serverNotes; renderNotes(); } } catch(e){ console.error('Refresh error',e); } }

function setupEventListeners(){
  addBtn.addEventListener('click', () => { createNote(); addBtn.classList.add('pulse'); setTimeout(()=>addBtn.classList.remove('pulse'),300); });
  addImageBtn.addEventListener('click', () => { standaloneImageUpload.click(); });
  colorBtn.addEventListener('click', () => { toggleColorPalette(); });
  document.querySelectorAll('.color-option').forEach(opt=> opt.addEventListener('click', (e)=>{ selectedColor = e.target.dataset.color; document.querySelectorAll('.color-option').forEach(o=>o.classList.toggle('active', o===e.target)); if (currentColorNote) { currentColorNote.style.backgroundColor = selectedColor; updateNoteColor(currentColorNote.dataset.id, selectedColor); currentColorNote = null; } colorPalette.style.display = 'none'; }));
  bgBtn.addEventListener('click', ()=> toggleBackgroundPicker());
  document.querySelectorAll('.bg-option').forEach(option=> option.addEventListener('click', (e)=>{ const bg = e.target.dataset.bg || e.target.parentElement.dataset.bg; if (bg === 'upload') { bgUpload.click(); } else { saveLocalBackground('color', backgrounds[bg] || '#f5f5f5'); } updateActiveBackground(bg); backgroundPicker.style.display = 'none'; }));
  bgUpload.addEventListener('change', handleBackgroundUpload);
  standaloneImageUpload.addEventListener('change', handleStandaloneImageUpload);

  searchBtn.addEventListener('click', ()=>{ toggleSearch(); });
  doSearch.addEventListener('click', performSearch);
  clearSearchBtn.addEventListener('click', clearSearchFunction);
  searchInput.addEventListener('keypress', (e)=> { if (e.key === 'Enter') performSearch(); });

  exportBtn.addEventListener('click', ()=> { exportNotes(); });

  importBtn.addEventListener('click', ()=> { importFile.click(); });
  importFile.addEventListener('change', handleImportFile);

  closeModal.addEventListener('click', ()=> imageModal.style.display = 'none');
  imageModal.addEventListener('click', (e)=> { if (e.target === imageModal) imageModal.style.display = 'none'; });

  soundToggle.addEventListener('click', ()=>{ soundsEnabled = !soundsEnabled; soundToggle.classList.toggle('muted', !soundsEnabled); soundToggle.textContent = soundsEnabled ? 'üîä' : 'üîá'; });

  document.addEventListener('click', (e)=>{ if (!colorBtn.contains(e.target) && !colorPalette.contains(e.target)) colorPalette.style.display = 'none'; if (!bgBtn.contains(e.target) && !backgroundPicker.contains(e.target)) backgroundPicker.style.display = 'none'; if (!searchBtn.contains(e.target) && !searchBox.contains(e.target)) searchBox.style.display = 'none'; });
  document.addEventListener('keydown', (e)=> { if ((e.ctrlKey || e.metaKey) && e.key === 'n') { e.preventDefault(); createNote(); } });
}

// --- Notes load/save ---
async function loadNotes(){ try { const response = await fetch('/api/notes'); if (!response.ok) throw new Error('Failed to load notes'); notes = await response.json(); renderNotes(); showStatus(`Loaded ${notes.length} notes`); } catch(e){ console.error('Load notes error', e); showStatus('Ready! Create your first note.'); } }
async function saveNotes(){ try { await fetch('/api/notes', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(notes) }); } catch(e){ console.error('Save notes error', e); } }

function showStatus(message, type=''){ status.textContent = message; status.className = `status ${type}`; }

// --- Create note ---
async function createNote(x=50,y=50){ const newNote = { id: Date.now().toString(), type:'note', x, y, width:250, height:200, title:'New Note', content:'Type your note here...', color:selectedColor, image:null, tags:[], isPublic:true, createdAt: new Date().toISOString() }; notes.push(newNote); renderNotes(); await saveNotes(); showStatus('New note created!'); }

// --- Image uploads ---
function handleStandaloneImageUpload(event){ const file = event.target.files[0]; if (!file) return; if (file.size > 5*1024*1024) { showStatus('Image too large! Max 5MB allowed.', 'updating'); return; } const reader = new FileReader(); reader.onload = (e)=>{ const standaloneImage = { id: Date.now().toString(), type:'image', x:100, y:100, width:300, height:300, src:e.target.result, isPublic:true, createdAt:new Date().toISOString() }; notes.push(standaloneImage); renderNotes(); saveNotes(); showStatus('Image added to wall!'); }; reader.readAsDataURL(file); }

// --- Render notes ---
function renderNotes(){ const activeElement = document.activeElement; let focusedNoteId = null; let selectionStart=null; let selectionEnd=null; if (activeElement && (activeElement.classList.contains('note-title') || activeElement.classList.contains('note-content'))) { const noteElement = activeElement.closest('.note'); if (noteElement) { focusedNoteId = noteElement.dataset.id; selectionStart = activeElement.selectionStart; selectionEnd = activeElement.selectionEnd; } }
  const existingElements = wall.querySelectorAll('.note, .standalone-image-container'); existingElements.forEach(el=>el.remove());
  notes.forEach(note=>{ if (note.type === 'image') { const imgEl = createImageElement(note); wall.appendChild(imgEl); } else { const noteEl = createNoteElement(note); wall.appendChild(noteEl); if (note.id === focusedNoteId) { const inputType = activeElement.classList.contains('note-title') ? 'note-title' : 'note-content'; const input = noteEl.querySelector(`.${inputType}`); if (input) setTimeout(()=>{ input.focus(); input.setSelectionRange(selectionStart, selectionEnd); }, 10); } } }); }

function createNoteElement(note){ const noteDiv = document.createElement('div'); noteDiv.className = 'note'; noteDiv.style.left = note.x + 'px'; noteDiv.style.top = note.y + 'px'; noteDiv.style.width = note.width + 'px'; noteDiv.style.height = note.height + 'px'; noteDiv.style.backgroundColor = note.color; noteDiv.dataset.id = note.id; noteDiv.innerHTML = `
    <div class="note-header">
      <input type="text" class="note-title" value="${escapeHtml(note.title)}" placeholder="Note title">
      <div class="note-controls">
        <button class="note-btn color-btn" title="Change color">üé®</button>
        <button class="note-btn tag-btn" title="Add tags">üè∑Ô∏è</button>
        <button class="note-btn image-btn" title="Add image">üñºÔ∏è</button>
        <button class="note-btn delete-btn" title="Delete note">√ó</button>
      </div>
    </div>
    <textarea class="note-content" placeholder="Type your note here...">${escapeHtml(note.content)}</textarea>
    ${note.tags && note.tags.length>0 ? `<div class="note-tags">${note.tags.map(tag=>`<span class="tag">${escapeHtml(tag)}</span>`).join('')}</div>` : ''}
    ${note.image ? `<img src="${note.image}" class="note-image" alt="Note image">` : ''}
    <div class="resize-handle" title="Resize"></div>
  `;
  setupNoteEvents(noteDiv, note);
  return noteDiv;
}

function createImageElement(note){ const container = document.createElement('div'); container.className = 'standalone-image-container'; container.style.left = note.x + 'px'; container.style.top = note.y + 'px'; container.style.width = note.width + 'px'; container.style.height = note.height + 'px'; container.dataset.id = note.id; container.innerHTML = `
    <img src="${note.src}" class="standalone-image" alt="Uploaded image">
    <div class="note-controls" style="position:absolute; top:8px; right:8px;">
      <button class="note-btn delete-btn" title="Delete image">√ó</button>
    </div>
    <div class="resize-handle" title="Resize"></div>
  `; setupImageEvents(container, note); return container; }

function setupNoteEvents(noteElement, noteData){ // delete
  noteElement.querySelector('.delete-btn').addEventListener('click', async (e)=>{ e.stopPropagation(); notes = notes.filter(n=>n.id !== noteData.id); renderNotes(); await saveNotes(); showStatus('Note deleted'); });
  // color
  noteElement.querySelector('.color-btn').addEventListener('click', (e)=>{ e.stopPropagation(); currentColorNote = noteElement; const rect = noteElement.getBoundingClientRect(); colorPalette.style.left = (rect.left - 100) + 'px'; colorPalette.style.top = (rect.top + 40) + 'px'; colorPalette.style.display = 'flex'; document.querySelectorAll('.color-option').forEach(opt=> opt.classList.toggle('active', opt.dataset.color === noteData.color)); });
  // tags
  noteElement.querySelector('.tag-btn').addEventListener('click', (e)=>{ e.stopPropagation(); const tag = prompt('Enter tags (comma separated):', noteData.tags ? noteData.tags.join(', ') : ''); if (tag !== null) { noteData.tags = tag.split(',').map(t=>t.trim()).filter(t=>t); renderNotes(); saveNotes(); showStatus('Tags updated'); } });
  // image
  noteElement.querySelector('.image-btn').addEventListener('click', (e)=>{ e.stopPropagation(); imageUpload.onchange = (e)=> handleImageUpload(e, noteData.id); imageUpload.click(); });
  const noteImage = noteElement.querySelector('.note-image'); if (noteImage) noteImage.addEventListener('click', ()=>{ modalImage.src = noteImage.src; imageModal.style.display = 'flex'; });
  // title
  const titleInput = noteElement.querySelector('.note-title'); titleInput.addEventListener('input', async (e)=>{ isUserTyping = true; noteData.title = e.target.value; await saveNotes(); setTimeout(()=>{ isUserTyping = false; },800); }); titleInput.addEventListener('focus', ()=>{ isUserTyping = true; }); titleInput.addEventListener('blur', ()=>{ isUserTyping = false; });
  // content
  const contentInput = noteElement.querySelector('.note-content'); contentInput.addEventListener('input', async (e)=>{ isUserTyping = true; noteData.content = e.target.value; await saveNotes(); setTimeout(()=>{ isUserTyping = false; },800); }); contentInput.addEventListener('focus', ()=>{ isUserTyping = true; }); contentInput.addEventListener('blur', ()=>{ isUserTyping = false; });
  setupDrag(noteElement, noteData); setupResize(noteElement, noteData);
}

function setupImageEvents(imageElement, imageData){ imageElement.querySelector('.delete-btn').addEventListener('click', async (e)=>{ e.stopPropagation(); notes = notes.filter(n=>n.id !== imageData.id); renderNotes(); await saveNotes(); showStatus('Image deleted'); }); const img = imageElement.querySelector('.standalone-image'); img.addEventListener('click', (e)=>{ if (e.target.classList.contains('note-btn')) return; modalImage.src = img.src; imageModal.style.display = 'flex'; }); setupDrag(imageElement, imageData); setupResize(imageElement, imageData); }

function setupDrag(element, data){ element.addEventListener('mousedown', (e)=>{ if (e.target.classList.contains('resize-handle') || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.classList.contains('note-btn')) return; e.preventDefault(); isDragging = true; currentElement = element; element.classList.add('dragging'); const rect = element.getBoundingClientRect(); dragOffset.x = e.clientX - rect.left; dragOffset.y = e.clientY - rect.top; function drag(e){ if (!isDragging) return; const x = e.clientX - dragOffset.x; const y = e.clientY - dragOffset.y; element.style.left = x + 'px'; element.style.top = y + 'px'; } function stopDrag(){ isDragging = false; element.classList.remove('dragging'); data.x = parseInt(element.style.left); data.y = parseInt(element.style.top); saveNotes(); document.removeEventListener('mousemove', drag); document.removeEventListener('mouseup', stopDrag); } document.addEventListener('mousemove', drag); document.addEventListener('mouseup', stopDrag); }); }

function setupResize(element, data){ const handle = element.querySelector('.resize-handle'); handle.addEventListener('mousedown', (e)=>{ e.preventDefault(); e.stopPropagation(); isResizing = true; element.classList.add('resizing'); resizeStartSize.width = element.offsetWidth; resizeStartSize.height = element.offsetHeight; resizeStartPos.x = e.clientX; resizeStartPos.y = e.clientY; function resize(e){ if (!isResizing) return; const deltaX = e.clientX - resizeStartPos.x; const deltaY = e.clientY - resizeStartPos.y; const newWidth = Math.max(200, resizeStartSize.width + deltaX); const newHeight = Math.max(150, resizeStartSize.height + deltaY); element.style.width = newWidth + 'px'; element.style.height = newHeight + 'px'; } function stopResize(){ isResizing = false; element.classList.remove('resizing'); data.width = parseInt(element.style.width); data.height = parseInt(element.style.height); saveNotes(); document.removeEventListener('mousemove', resize); document.removeEventListener('mouseup', stopResize); } document.addEventListener('mousemove', resize); document.addEventListener('mouseup', stopResize); }); }

function handleImageUpload(event, noteId){ const file = event.target.files[0]; if (!file) return; if (file.size > 5*1024*1024) { showStatus('Image too large! Max 5MB allowed.', 'updating'); return; } const reader = new FileReader(); reader.onload = (e)=>{ const note = notes.find(n=>n.id === noteId); if (note) { note.image = e.target.result; renderNotes(); saveNotes(); showStatus('Image added to note!'); } }; reader.readAsDataURL(file); }

function handleBackgroundUpload(event){ const file = event.target.files[0]; if (!file) return; if (file.size > 10*1024*1024) { showStatus('Background image too large! Max 10MB allowed.', 'updating'); return; } const reader = new FileReader(); reader.onload = (e)=>{ saveLocalBackground('image', e.target.result); updateActiveBackground('upload'); showStatus('Background updated!'); }; reader.readAsDataURL(file); }

function updateActiveBackground(activeBg){ document.querySelectorAll('.bg-option').forEach(option => option.classList.toggle('active', option.dataset.bg === activeBg)); }
function updateNoteColor(noteId, color){ const note = notes.find(n=>n.id === noteId); if (note){ note.color = color; saveNotes(); } }
function toggleColorPalette(){ const isVisible = colorPalette.style.display === 'flex'; colorPalette.style.display = isVisible ? 'none' : 'flex'; backgroundPicker.style.display = 'none'; searchBox.style.display = 'none'; currentColorNote = null; }
function toggleBackgroundPicker(){ const isVisible = backgroundPicker.style.display === 'flex'; backgroundPicker.style.display = isVisible ? 'none' : 'flex'; colorPalette.style.display = 'none'; searchBox.style.display = 'none'; }
function toggleSearch(){ const isVisible = searchBox.style.display === 'block'; searchBox.style.display = isVisible ? 'none' : 'block'; colorPalette.style.display = 'none'; backgroundPicker.style.display = 'none'; if (!isVisible) searchInput.focus(); }

async function performSearch(){ const query = searchInput.value; if (!query.trim()) return; try { const response = await fetch(`/api/notes/search?query=${encodeURIComponent(query)}`); const searchResults = await response.json(); notes = searchResults; renderNotes(); showStatus(`Found ${searchResults.length} notes matching "${query}"`); } catch(e){ showStatus('Search failed','updating'); } }
function clearSearchFunction(){ searchInput.value = ''; loadNotes(); searchBox.style.display = 'none'; }

// Export (unchanged)
async function exportNotes(){ try { const response = await fetch('/api/export'); const blob = await response.blob(); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `notes-export-${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); window.URL.revokeObjectURL(url); showStatus('Notes exported successfully!'); } catch(e){ showStatus('Export failed','updating'); } }

// --- Import handling ---
async function handleImportFile(event){ const file = event.target.files[0]; if (!file) return; if (!file.name.endsWith('.json')) { showStatus('Please select a JSON file', 'updating'); return; } try { const text = await file.text(); const parsed = JSON.parse(text);
    if (!Array.isArray(parsed)) { showStatus('Invalid export file format (expected array)', 'updating'); return; }
    // Optionally validate minimal shape for each note
    // Confirm with user (simple confirm dialog)
    if (!confirm(`This will replace all notes on the server with the ${parsed.length} notes from the file. Continue?`)) return;
    // Post to existing /api/notes endpoint which clears and inserts
    const resp = await fetch('/api/notes', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(parsed) });
    if (!resp.ok) { showStatus('Import failed', 'updating'); return; }
    // Reload from server to ensure canonical state
    await loadNotes(); showStatus('Import successful! Notes restored.');
  } catch(e){ console.error('Import error', e); showStatus('Import failed: invalid JSON', 'updating'); } finally { importFile.value = ''; }
}

// --- Helpers ---
function escapeHtml(str){ if (str === undefined || str === null) return ''; return String(str).replace(/[&<>"]+/g, (s)=>{ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s] || s; }); }

// --- Start ---
init();
</script>
</body>
</html>
